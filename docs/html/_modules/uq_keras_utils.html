

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>uq_keras_utils &mdash; CANDLE  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> CANDLE
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../readme.html">What is CANDLE?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../candle_lib.html">CANDLE Library API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute.html">How to Contribute</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CANDLE</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>uq_keras_utils</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for uq_keras_utils</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>


<span class="kn">from</span> <span class="nn">keras</span> <span class="kn">import</span> <span class="n">backend</span> <span class="k">as</span> <span class="n">K</span>

<span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="kn">import</span> <span class="n">Callback</span>

<span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span>

<span class="kn">from</span> <span class="nn">keras.utils</span> <span class="kn">import</span> <span class="n">np_utils</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1">###################################################################</span>

<span class="c1"># For Abstention Model</span>

<span class="c1"># These are the parameters of the abstention loss</span>
<span class="n">mu</span> <span class="o">=</span> <span class="kc">None</span>   <span class="c1"># Factor weighting abstention term in cost function (auto tunes)</span>
<span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Mask for abstention: it is 1 on the output associated to the</span>
            <span class="c1"># abstention class and 0 otherwise</span>
<span class="n">nb_classes</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># integer or vector of integers with the index of the abstention class</span>

<div class="viewcode-block" id="abstention_variable_initialization"><a class="viewcode-back" href="../candle_lib/uq_keras_utils.html#uq_keras_utils.abstention_variable_initialization">[docs]</a><span class="k">def</span> <span class="nf">abstention_variable_initialization</span><span class="p">(</span><span class="n">mu0</span><span class="p">,</span> <span class="n">mask_</span><span class="p">,</span> <span class="n">nb_classes_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function that initializes parameters of the abstention loss</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mu0 : float</span>
<span class="sd">        Initial weight of abstention term in cost function</span>
<span class="sd">    mask_ : ndarray</span>
<span class="sd">        Numpy array to use as initialiser for global mask variable</span>
<span class="sd">    nb_classes_ : int or ndarray</span>
<span class="sd">        Integer or numpy array defining indices of the abstention class</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">mu</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">nb_classes</span>

    <span class="c1"># Parameter Initialization</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">mu0</span><span class="p">)</span>     <span class="c1"># Weight of abstention term</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">mask_</span><span class="p">)</span> <span class="c1"># Mask to compute cost</span>
    <span class="n">nb_classes</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">nb_classes_</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span> <span class="c1"># integer or vector of integers with the index of the abstention class</span></div>


<div class="viewcode-block" id="abstention_loss"><a class="viewcode-back" href="../candle_lib/uq_keras_utils.html#uq_keras_utils.abstention_loss">[docs]</a><span class="k">def</span> <span class="nf">abstention_loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function to compute abstention loss. It is composed by two terms: (i) original loss of the multiclass classification problem, (ii) cost associated to the abstaining samples.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    y_true : keras tensor</span>
<span class="sd">        True values to predict</span>
<span class="sd">    y_pred : keras tensor</span>
<span class="sd">        Prediction made by the model. It is assumed that this keras tensor includes extra columns to store the abstaining classes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">base_pred</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">mask</span><span class="p">)</span><span class="o">*</span><span class="n">y_pred</span>
    <span class="n">base_true</span> <span class="o">=</span> <span class="n">y_true</span>
    <span class="n">base_cost</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">categorical_crossentropy</span><span class="p">(</span><span class="n">base_true</span><span class="p">,</span><span class="n">base_pred</span><span class="p">)</span>
    <span class="n">abs_pred</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mask</span><span class="o">*</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">abs_pred</span><span class="p">)</span><span class="o">*</span><span class="n">base_cost</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">K</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">abs_pred</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cost</span></div>


<div class="viewcode-block" id="abs_acc"><a class="viewcode-back" href="../candle_lib/uq_keras_utils.html#uq_keras_utils.abs_acc">[docs]</a><span class="k">def</span> <span class="nf">abs_acc</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function to estimate accuracy over the predicted samples after removing the samples where the model is abstaining.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    y_true : keras tensor</span>
<span class="sd">        True values to predict</span>
<span class="sd">    y_pred : keras tensor</span>
<span class="sd">        Prediction made by the model. It is assumed that this keras tensor includes extra columns to store the abstaining classes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># matching in original classes</span>
    <span class="n">true_pred</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">K</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)),</span> <span class="s1">&#39;int64&#39;</span><span class="p">))</span>

    <span class="c1"># total abstention</span>
    <span class="n">total_abs</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">nb_classes</span><span class="p">),</span> <span class="s1">&#39;int64&#39;</span><span class="p">))</span>

    <span class="c1"># total predicted in original classes</span>
    <span class="n">total_pred</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">K</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)),</span> <span class="s1">&#39;int64&#39;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">true_pred</span><span class="o">/</span><span class="p">(</span><span class="n">total_pred</span> <span class="o">-</span> <span class="n">total_abs</span><span class="p">)</span></div>


<div class="viewcode-block" id="acc_class1"><a class="viewcode-back" href="../candle_lib/uq_keras_utils.html#uq_keras_utils.acc_class1">[docs]</a><span class="k">def</span> <span class="nf">acc_class1</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function to estimate accuracy over the class 1 prediction. This estimation is global (i.e. abstaining samples are not removed)</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    y_true : keras tensor</span>
<span class="sd">        True values to predict</span>
<span class="sd">    y_pred : keras tensor</span>
<span class="sd">        Prediction made by the model. It is assumed that this keras tensor includes extra columns to store the abstaining classes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Find samples in ground truth belonging to class 1</span>
    <span class="n">ytrueint</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Compute total number of ground truth samples in class 1</span>
    <span class="n">total_true1</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ytrueint</span><span class="p">)</span>

    <span class="c1"># Find samples in prediction belonging to class 1</span>
    <span class="n">ypredint</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Find correctly predicted class 1 samples</span>
    <span class="n">true1_pred</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ytrueint</span><span class="o">*</span><span class="n">ypredint</span><span class="p">)</span>

    <span class="c1"># Compute accuracy in class 1</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">true1_pred</span> <span class="o">/</span> <span class="n">total_true1</span>

    <span class="c1"># Since there are so few samples in class 1</span>
    <span class="c1"># it is possible that ground truth does not</span>
    <span class="c1"># have any sample in class 1, leading to a divide</span>
    <span class="c1"># by zero and not valid accuracy</span>
    <span class="c1"># Therefore, for the accuracy to be valid</span>
    <span class="c1"># total_true1 should be greater than zero</span>
    <span class="c1"># otherwise, return 0.</span>

    <span class="n">condition</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">total_true1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">K</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">K</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">acc</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span></div>


<div class="viewcode-block" id="abs_acc_class1"><a class="viewcode-back" href="../candle_lib/uq_keras_utils.html#uq_keras_utils.abs_acc_class1">[docs]</a><span class="k">def</span> <span class="nf">abs_acc_class1</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function to estimate accuracy over the class 1 prediction after removing the samples where the model is abstaining</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    y_true : keras tensor</span>
<span class="sd">        True values to predict</span>
<span class="sd">    y_pred : keras tensor</span>
<span class="sd">        Prediction made by the model. It is assumed that this keras tensor includes extra columns to store the abstaining classes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Find locations of true 1 prediction</span>
    <span class="n">ytrueint</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Find locations that are predicted (not abstained)</span>
    <span class="n">mask_pred</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">not_equal</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">nb_classes</span><span class="p">),</span> <span class="s1">&#39;int64&#39;</span><span class="p">)</span>

    <span class="c1"># Compute total number of ground truth samples in class 1 filtering abstaining predictions</span>
    <span class="n">total_true1</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ytrueint</span> <span class="o">*</span> <span class="n">mask_pred</span><span class="p">)</span>

    <span class="c1"># matching in original class 1 after removing abstention</span>
    <span class="n">true1_pred</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask_pred</span> <span class="o">*</span> <span class="n">ytrueint</span> <span class="o">*</span> <span class="n">K</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">K</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)),</span> <span class="s1">&#39;int64&#39;</span><span class="p">))</span>

    <span class="c1"># Compute accuracy in class 1</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">true1_pred</span> <span class="o">/</span> <span class="n">total_true1</span>

    <span class="c1"># Since there are so few samples in class 1</span>
    <span class="c1"># it is possible that ground truth does not</span>
    <span class="c1"># have any sample in class 1, leading to a divide</span>
    <span class="c1"># by zero and not valid accuracy</span>
    <span class="c1"># Therefore, for the accuracy to be valid</span>
    <span class="c1"># total_true1 should be greater than zero</span>
    <span class="c1"># otherwise, return 0.</span>

    <span class="n">condition</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">total_true1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">K</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">K</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">acc</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span></div>


<div class="viewcode-block" id="AbstentionAdapt_Callback"><a class="viewcode-back" href="../candle_lib/uq_keras_utils.html#uq_keras_utils.AbstentionAdapt_Callback">[docs]</a><span class="k">class</span> <span class="nc">AbstentionAdapt_Callback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This callback is used to adapt the parameter mu in the abstention loss.</span>
<span class="sd">        Factor mu (weight of the abstention term in the abstention loss) is increased or decreased to try to match the accuracy set as target.</span>
<span class="sd">        The accuracy to use must be specified as the &#39;monitor&#39; argument in the initialization of the callback. It could be: the accuracy without abstention samples (abs_acc), the accuracy over class 1 without abstention samples (abs_acc_class1), etc.</span>
<span class="sd">        If the current monitored accuracy is smaller than the target set, mu increases to promote more abstention.</span>
<span class="sd">        If the current monitored accuracy is greater than the target set, mu decreases to promote more predictions (less abstention).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitor</span><span class="p">,</span> <span class="n">init_abs_epoch</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">target_acc</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initializer of the AbstentionAdapt_Callback.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        monitor : keras metric</span>
<span class="sd">            Metric to monitor during the run and use as base to adapt the weight of the abstention term (i.e. mu) in the asbstention cost function</span>
<span class="sd">        init_abs_epoch : integer</span>
<span class="sd">            Value of the epochs to start adjusting the weight of the abstention term (i.e. mu). Default: 4.</span>
<span class="sd">        scale_factor: float</span>
<span class="sd">            Factor to scale (increase by dividing or decrease by multiplying) the weight of the abstention term (i.e. mu). Default: 0.95.</span>
<span class="sd">        target_acc: float</span>
<span class="sd">            Target accuracy to achieve in the current training. Default: 0.95.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AbstentionAdapt_Callback</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">monitor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_abs_epoch</span> <span class="o">=</span> <span class="n">init_abs_epoch</span> <span class="c1"># epoch to init abstention</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span> <span class="o">=</span> <span class="n">scale_factor</span> <span class="c1"># factor to scale mu (weight for abstention term in cost function)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_acc</span> <span class="o">=</span> <span class="n">target_acc</span> <span class="c1"># target accuracy (value specified as parameter of the run)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muvalues</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># array to store mu evolution</span>

        
<div class="viewcode-block" id="AbstentionAdapt_Callback.on_epoch_end"><a class="viewcode-back" href="../candle_lib/uq_keras_utils.html#uq_keras_utils.AbstentionAdapt_Callback.on_epoch_end">[docs]</a>    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initializer of the AbstentionAdapt_Callback.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        epoch : integer</span>
<span class="sd">            Current epoch in training.</span>
<span class="sd">        logs : keras logs</span>
<span class="sd">            Metrics stored during current keras training.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">new_mu_val</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_abs_epoch</span><span class="p">:</span>
        
            <span class="n">current</span> <span class="o">=</span> <span class="n">logs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span> <span class="s1">&#39;Abstention Adapt conditioned on metric `</span><span class="si">%s</span><span class="s1">` &#39;</span> <span class="s1">&#39;which is not available. Available metrics are: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">logs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))),</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># modify mu as needed</span>
                <span class="k">if</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_acc</span><span class="p">:</span> <span class="c1">#increase abstention penalty</span>
                    <span class="n">new_mu_val</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span>
                <span class="k">elif</span> <span class="n">current</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_acc</span><span class="p">:</span> <span class="c1">#decrease abstention penalty</span>
                    <span class="n">new_mu_val</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span>

                <span class="n">K</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">new_mu_val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muvalues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">new_mu_val</span> <span class="p">)</span></div></div>

        <span class="c1">#print(&#39;epoch: %d, mu: %f&#39; % (epoch, new_mu_val))</span>


<div class="viewcode-block" id="modify_labels"><a class="viewcode-back" href="../candle_lib/uq_keras_utils.html#uq_keras_utils.modify_labels">[docs]</a><span class="k">def</span> <span class="nf">modify_labels</span><span class="p">(</span><span class="n">numclasses_out</span><span class="p">,</span> <span class="n">ytrain</span><span class="p">,</span> <span class="n">ytest</span><span class="p">,</span> <span class="n">yval</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This function generates a categorical representation with a class added for indicating abstention.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    numclasses_out : integer</span>
<span class="sd">        Original number of classes + 1 abstention class</span>
<span class="sd">    ytrain : ndarray</span>
<span class="sd">        Numpy array of the classes (labels) in the training set</span>
<span class="sd">    ytest : ndarray</span>
<span class="sd">        Numpy array of the classes (labels) in the testing set</span>
<span class="sd">    yval : ndarray</span>
<span class="sd">        Numpy array of the classes (labels) in the validation set</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">classestrain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ytrain</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">classestest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ytest</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">classesval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">yval</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">assert</span><span class="p">(</span> <span class="n">classestrain</span> <span class="o">==</span> <span class="n">classestest</span> <span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span> <span class="n">classesval</span> <span class="o">==</span> <span class="n">classestest</span> <span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span> <span class="p">(</span><span class="n">classestrain</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">numclasses_out</span> <span class="p">)</span> <span class="c1"># In this case only one other slot for abstention is created</span>

    <span class="n">labels_train</span> <span class="o">=</span> <span class="n">np_utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span> <span class="n">ytrain</span><span class="p">,</span> <span class="n">numclasses_out</span> <span class="p">)</span>
    <span class="n">labels_test</span> <span class="o">=</span> <span class="n">np_utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span> <span class="n">ytest</span><span class="p">,</span> <span class="n">numclasses_out</span> <span class="p">)</span>
    <span class="n">labels_val</span> <span class="o">=</span> <span class="n">np_utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span> <span class="n">yval</span><span class="p">,</span> <span class="n">numclasses_out</span> <span class="p">)</span>

    <span class="c1"># For sanity check</span>
    <span class="n">mask_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">labels_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">mask_vec</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">labels_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">sanity_check</span> <span class="o">=</span> <span class="n">mask_vec</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">*</span><span class="n">labels_train</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sanity_check</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ytrain</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">ytrain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">ll</span> <span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">numclasses_out</span> <span class="p">):</span>
            <span class="k">if</span> <span class="n">sanity_check</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Problem at &#39;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">labels_train</span><span class="p">,</span> <span class="n">labels_test</span><span class="p">,</span> <span class="n">labels_val</span></div>

<span class="c1">###################################################################</span>

<div class="viewcode-block" id="add_model_output"><a class="viewcode-back" href="../candle_lib/uq_keras_utils.html#uq_keras_utils.add_model_output">[docs]</a><span class="k">def</span> <span class="nf">add_model_output</span><span class="p">(</span><span class="n">modelIn</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_add</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This function modifies the last dense layer in the passed keras model. The modification includes adding units and optionally changing the activation function.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    modelIn : keras model</span>
<span class="sd">        Keras model to be modified.</span>
<span class="sd">    mode : string</span>
<span class="sd">        Mode to modify the layer. It could be:</span>
<span class="sd">        &#39;abstain&#39; for adding an arbitrary number of units for the abstention optimization strategy.</span>
<span class="sd">        &#39;qtl&#39; for quantile regression which needs the outputs to be tripled.</span>
<span class="sd">        &#39;het&#39; for heteroscedastic regression which needs the outputs to be doubled. (current implicit default: &#39;het&#39;)</span>
<span class="sd">    num_add : integer</span>
<span class="sd">        Number of units to add. This only applies to the &#39;abstain&#39; mode.</span>
<span class="sd">    activation : string</span>
<span class="sd">        String with keras specification of activation function (e.g. &#39;relu&#39;, &#39;sigomid&#39;, &#39;softmax&#39;, etc.)</span>
<span class="sd">        </span>
<span class="sd">    Return</span>
<span class="sd">    ----------</span>
<span class="sd">    modelOut : keras model</span>
<span class="sd">        Keras model after last dense layer has been modified as specified. If there is no mode specified it returns the same model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">modelIn</span>

    <span class="n">numlayers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">modelIn</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span>
    <span class="c1"># Find last dense layer</span>
    <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">while</span> <span class="s1">&#39;dense&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">modelIn</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="n">numlayers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="c1"># Minimal verification about the validity of the layer found</span>
    <span class="k">assert</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="n">numlayers</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="s1">&#39;dense&#39;</span> <span class="ow">in</span> <span class="n">modelIn</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># Compute new output size</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="s1">&#39;abstain&#39;</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">num_add</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">new_output_size</span> <span class="o">=</span> <span class="n">modelIn</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">output_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">num_add</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="ow">is</span> <span class="s1">&#39;qtl&#39;</span><span class="p">:</span> <span class="c1"># for quantile UQ</span>
        <span class="n">new_output_size</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">modelIn</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">output_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># for heteroscedastic UQ</span>
        <span class="n">new_output_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">modelIn</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">output_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Recover current layer options</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">modelIn</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
    <span class="c1"># Update number of units</span>
    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_output_size</span>
    <span class="c1"># Update activation function if requested</span>
    <span class="k">if</span> <span class="n">activation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;activation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">activation</span>
    <span class="c1"># Create new Dense layer</span>
    <span class="n">reconstructed_layer</span> <span class="o">=</span> <span class="n">Dense</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="c1"># Connect new Dense last layer to previous one-before-last layer</span>
    <span class="n">additional</span> <span class="o">=</span> <span class="n">reconstructed_layer</span><span class="p">(</span><span class="n">modelIn</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
    <span class="c1"># If the layer to replace is not the last layer, add the remainder layers</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">config_j</span> <span class="o">=</span> <span class="n">modelIn</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
            <span class="n">aux_j</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">deserialize</span><span class="p">({</span><span class="s1">&#39;class_name&#39;</span><span class="p">:</span> <span class="n">modelIn</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                        <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">config_j</span><span class="p">})</span>
            <span class="n">reconstructed_layer</span> <span class="o">=</span> <span class="n">aux_j</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">config_j</span><span class="p">)</span>
            <span class="n">additional</span> <span class="o">=</span> <span class="n">reconstructed_layer</span><span class="p">(</span><span class="n">additional</span><span class="p">)</span>

    <span class="n">modelOut</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">modelIn</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="n">additional</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">modelOut</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, ANL.gov

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>